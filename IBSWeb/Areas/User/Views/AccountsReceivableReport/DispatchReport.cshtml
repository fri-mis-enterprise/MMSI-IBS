@using IBS.Utility.Helpers
@using Microsoft.AspNetCore.Mvc.TagHelpers
@model DispatchReportViewModel

@{
    ViewData["Title"] = "Accounts Receivable Report - Dispatch";
}

<div class="card shadow border-0 mt-4">
    <div class="card-header bg-secondary bg-gradient ml-0 py-3">
        <div class="row">
            <div class="col-12 text-center">
                <h2 class="text-white py-2">@ViewData["Title"]</h2>
            </div>
        </div>
    </div>

    <div class="card-body p-4">
        <form id="dynamicForm" method="post" target="_blank">

            <!-- Report Type -->
            <div class="form-group row">
                <label asp-for="ReportType" class="col-sm-4 col-form-label text-right">
                    Select Report Type
                </label>
                <div class="col-sm-6">
                    <select id="reportType"
                            class="form-control js-select2"
                            asp-for="ReportType"
                            required
                            style="width: 100%;">
                        <option value="Delivered" selected>Delivered</option>
                        <option value="InTransit">In-Transit Deliveries</option>
                    </select>
                </div>
            </div>

            <!-- Date From -->
            <div class="form-group row mt-4">
                <label asp-for="DateFrom" class="col-sm-4 col-form-label text-right">
                    Date From
                </label>
                <div class="col-sm-6">
                    <input type="date"
                           id="dateFrom"
                           class="form-control"
                           asp-for="DateFrom"
                           value="@DateOnly.FromDateTime(DateTimeHelper.GetCurrentPhilippineTime()).ToString("yyyy-MM-dd")"
                           required />
                </div>
            </div>

            <!-- Date To -->
            <div class="form-group row mt-4">
                <label asp-for="DateTo" class="col-sm-4 col-form-label text-right">
                    Date To
                </label>
                <div class="col-sm-6">
                    <input type="date"
                           id="dateTo"
                           class="form-control"
                           asp-for="DateTo" />
                    <small id="dateToHelp" class="text-muted">
                        Optional for Delivered reports
                    </small>
                </div>
            </div>

            <!-- Actions -->
            <div class="row mt-5">
                <div class="col-6 col-md-3">
                    <button type="button"
                            class="btn btn-primary form-control"
                            onclick="submitForm('GenerateDispatchReportExcelFile')">
                        <i class="bi bi-file-text"></i> Generate as Excel file
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function () {
            const reportType = $("#reportType");

            const dateFromGroup = $("#dateFrom").closest(".form-group");
            const dateToGroup = $("#dateTo").closest(".form-group");

            const dateFrom = $("#dateFrom");
            const dateTo = $("#dateTo");
            const dateToHelp = $("#dateToHelp");

            function updateUI() {
                const value = reportType.val();

                if (value === "InTransit") {
                    // Hide date filters
                    dateFromGroup.hide();
                    dateToGroup.hide();

                    // Remove validation
                    dateFrom.prop("required", false).val("");
                    dateTo.prop("required", false).val("");
                } else {
                    // Delivered
                    dateFromGroup.show();
                    dateToGroup.show();

                    dateFrom.prop("required", true);
                    dateTo.prop("required", false);

                    dateTo.addClass("bg-light");
                    dateToHelp.text("Optional for Delivered reports");
                }
            }

            // Select2-safe change event
            reportType.on("change.select2", updateUI);

            // Initial state
            updateUI();
        });

        function submitForm(action) {
            const form = document.getElementById("dynamicForm");

            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            form.action = action;
            form.submit();
        }
    </script>
}

