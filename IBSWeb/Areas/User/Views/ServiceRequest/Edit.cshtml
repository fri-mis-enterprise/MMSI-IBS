@model ServiceRequestViewModel

@{
    ViewData["Title"] = "Service Request - Edit";
    var filterType = ViewBag.FilterType as string;
}

<style>
    .section-header {
        font-size: 1rem;
        font-weight: 600;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
    }

    .duration-badge {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
    }

    @@media (max-width: 768px) {
        .btn{
            width: 100px !important;
        }
        
        label {
            font-size: .8em !important
        }
        input {
            font-size: .9em !important;
        }
        html {
            font-size: 16px;
        }

        table td {
            font-size: 10px;
            padding: 5px !important;
            margin: 0 !important;
        }

        table th {
            font-size: 12px;
            padding: 0 !important;
            margin: 0 !important;
        }

        span {
            font-size: 10px !important;
        }

        .btn {
            font-size: 12px !important;
        }

        ul li {
            font-size: 12px !important;
        }

        .form-select {
            font-size: 10px;
            min-width: 120px; /* Adjust as needed */
            width: auto; /* Adjust or set a fixed width if necessary */
            max-width: 120px; /* Prevent it from being too wide */
        }

        label[for="dt-length-0"] {
            font-size: 10px;
            margin-left: 2px;
        }

        label[for="dt-search-0"] {
            font-size: .8em;
        }
    }
</style>

<link rel="stylesheet" href="~/css/form-style.css">

<div class="container-fluid mt-4">
    <div class="card shadow">

        <div class="card-header bg-secondary bg-gradient ml-0 py-3">
            <div class="col-12 text-center">
                <h2 class="text-white py-2">@ViewData["Title"]</h2>
            </div>
        </div>
        
        <div class="card-body">
            
            <form id="myForm" method="post" class="row" enctype="multipart/form-data">
                <input asp-for="DispatchTicketId" type="hidden">
                <div class="border-2 px-3">
                    <div asp-validation-summary="ModelOnly"></div>

                    <!-- I. Reference Information -->
                    <h5 class="section-header text-secondary border-bottom"><i class="bi bi-info-circle me-2"></i>I. Reference Information</h5>
                    <div class="row">
                        <div class="form-floating col-md-3 col-6 my-2">
                            <input asp-for="Date" type="date" value="@(Model.Date?.ToString("yyyy-MM-dd"))" class="form-control border-0 shadow" id="Date" placeholder=" ">
                            <label asp-for="Date" for="Date" class="ms-2">Date Today<span class="required text-danger">*</span></label>
                            <span asp-validation-for="Date" class="text-danger"></span>
                        </div>
                        <div class="form-floating col-md-3 col-6 my-2">
                            <input asp-for="DispatchNumber" type="text" class="form-control border-0 shadow" id="DispatchNumber" placeholder=" " maxlength="20" title="Dispatch Number must not exceed 20 characters" required>
                            <label asp-for="DispatchNumber" for="DispatchNumber" class="ms-2">Dispatch/Mooring #<span class="required text-danger">*</span></label>
                            <span asp-validation-for="DispatchNumber" class="text-danger"></span>
                        </div>
                        <div class="form-floating col-md-3 col-6 my-2">
                            <input asp-for="COSNumber" type="text" class="form-control border-0 shadow" id="COSNumber" placeholder="" maxlength="10" title="COS Number must not exceed 10 characters">
                            <label asp-for="COSNumber" for="COSNumber" class="ms-2">COS#(Optional)</label>
                            <span asp-validation-for="COSNumber" class="text-danger"></span>
                        </div>
                        <div class="form-floating col-md-3 col-6 my-2">
                            <input asp-for="VoyageNumber" type="text" class="form-control border-0 shadow" id="VoyageNumber" placeholder=" " maxlength="20">
                            <label asp-for="VoyageNumber" for="VoyageNumber" class="ms-2">Voyage#(Optional)</label>
                            <span asp-validation-for="VoyageNumber" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- II. Timeline & Duration -->
                    <div class="d-flex justify-content-between align-items-center border-bottom mt-4 mb-2">
                        <h5 class="section-header text-secondary mb-0 border-0"><i class="bi bi-clock-history me-2"></i>II. Timeline & Duration</h5>
                        <div id="durationDisplay" class="badge bg-secondary duration-badge shadow-sm" style="display: none;">
                            Duration: <span id="totalHours">0</span> hours
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-floating col-md-3 col-6 my-2">
                            <input type="date" asp-for="DateLeft" value="@(Model.DateLeft?.ToString("yyyy-MM-dd"))" class="form-control border-0 shadow timeline-input" id="DateLeft" placeholder=" ">
                            <label asp-for="DateLeft" for="DateLeft" class="ms-2">Date Start</label>
                            <span asp-validation-for="DateLeft" class="text-danger"></span>
                        </div>
                        <div class="form-floating col-md-3 col-6 my-2">
                            <input type="time" asp-for="TimeLeft" value="@(Model.TimeLeft?.ToString("HH\\:mm"))" class="form-control border-0 shadow timeline-input" id="TimeLeft" placeholder=" ">
                            <label asp-for="TimeLeft" for="TimeLeft" class="ms-2">Time Start</label>
                            <span asp-validation-for="TimeLeft" class="text-danger"></span>
                        </div>
                        <div class="form-floating col-md-3 col-6 my-2">
                            <input type="date" asp-for="DateArrived" value="@(Model.DateArrived?.ToString("yyyy-MM-dd"))" class="form-control border-0 shadow timeline-input" id="DateArrived" placeholder=" ">
                            <label asp-for="DateArrived" for="DateArrived" class="ms-2">Date End</label>
                            <span asp-validation-for="DateArrived" class="text-danger"></span>
                        </div>
                        <div class="form-floating col-md-3 col-6 my-2">
                            <input type="time" asp-for="TimeArrived" value="@(Model.TimeArrived?.ToString("HH\\:mm"))" class="form-control border-0 shadow timeline-input" id="TimeArrived" placeholder=" ">
                            <label asp-for="TimeArrived" for="TimeArrived" class="ms-2">Time End</label>
                            <span asp-validation-for="TimeArrived" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- III. Service Details -->
                    <h5 class="section-header text-secondary border-bottom"><i class="bi bi-geo-alt me-2"></i>III. Service Details</h5>
                    <div class="row">
                        <div class="form-group col-12 my-2">
                            <label class="control-label ps-1 pb-1">Customer</label>
                            <select id="CustomerId" asp-for="CustomerId" asp-items="@Model.Customers" class="port-select form-select js-select2 border-0 shadow ms-5 mt-4" style="width:100%">
                                <option value="">Select Customer</option>
                            </select>
                            <span asp-validation-for="CustomerId" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-6 col-12 my-2">
                            <label class="control-label ps-1 pb-1">Vessel</label>
                            <select asp-for="VesselId" asp-items="@Model.Vessels" class="form-select js-select2 border-0 shadow ms-5 mt-4" style="width:100%">
                                <option value="">Select Vessel</option>
                            </select>
                            <span asp-validation-for="VesselId" class="text-danger"></span>
                        </div>
                        <div class="form-group col-md-3 col-6 my-2">
                            <label class="control-label ps-1 pb-1">Port</label>
                            <select asp-for="PortId" id="PortSelect" asp-items="@Model.Ports" class="port-select form-select js-select2 border-0 shadow ms-5 mt-4" style="width:100%">
                                <option value="">Select Port</option>
                            </select>
                            <span class="text-danger"></span>
                        </div>
                        <div class="form-group col-md-3 col-6 my-2">
                            <label class="control-label ps-1 pb-1">Terminal <span id="terminalLoading" class="spinner-border spinner-border-sm text-secondary ms-1" style="display:none;" role="status"></span></label>
                            <select id="TerminalSelect" asp-items="@Model.Terminals" asp-for="TerminalId" class="form-select js-select2 border-0 shadow ms-5 mt-4" style="width:100%">
                                <option value="">Select Terminal</option>
                            </select>
                            <span asp-validation-for="TerminalId" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- IV. Provider Details -->
                    <h5 class="section-header text-secondary border-bottom"><i class="bi bi-person-badge me-2"></i>IV. Provider Details</h5>
                    <div class="row">
                        <div class="form-group col-md-4 col-12 my-2">
                            <label class="control-label ps-1 pb-1">Activity/Service Type</label>
                            <select asp-for="ServiceId" asp-items="@Model.Services" class="form-select js-select2 border-0 shadow ms-5 mt-4" style="width:100%">
                                <option value="">Select Service</option>
                            </select>
                            <span asp-validation-for="ServiceId" class="text-danger"></span>
                        </div>

                        <div class="form-group col-md-4 col-6 my-2">
                            <label class="control-label ps-1 pb-1">Tugboat/Service provider</label>
                            <select asp-for="TugBoatId" asp-items="@Model.Tugboats" class="form-select js-select2 border-0 shadow ms-5 mt-4" style="width:100%">
                                <option value="">Select Tugboat</option>
                            </select>
                            <span asp-validation-for="TugBoatId" class="text-danger"></span>
                        </div>
                        <div class="form-group col-md-4 col-6 my-2">
                            <label class="control-label pb-1">Master on Duty</label>
                            <select asp-for="TugMasterId" asp-items="@Model.TugMasters" class="form-select js-select2 border-0 shadow ms-5 mt-4" style="width:100%">
                                <option value="">Select Tug Master</option>
                            </select>
                            <span asp-validation-for="TugMasterId" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- V. Remarks & Media -->
                    <h5 class="section-header text-secondary border-bottom"><i class="bi bi-chat-left-text me-2"></i>V. Media & Remarks</h5>
                    <div class="row">
                        <div class="form-floating col-12 my-2">
                            <input asp-for="Remarks" value="@Model.Remarks" type="text" class="form-control border-0 shadow" id="Remarks" maxlength="100" placeholder=" ">
                            <label asp-for="Remarks" for="Remarks" class="ms-2">Remarks(Optional)</label>
                            <span asp-validation-for="Remarks" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-6 col-12 my-2">
                            <label for="imageUpload" class="form-label">Upload image of Dispatch Ticket</label>
                            <input class="form-control form-control-sm border-0 shadow" id="imageUpload" name="imageFile" type='file' accept="image/png, image/jpg, image/jpeg"/>
                        </div>
                        <div class="form-group col-md-6 col-12 my-2">
                            <label for="videoUpload" class="form-label">Upload video of service operation</label>
                            <input class="form-control form-control-sm border-0 shadow" id="videoUpload" name="videoFile" type='file' accept="video/mp4, video/ogg"/>
                        </div>
                    </div>
                </div>
                
                <div class="row col-12 justify-content-end my-4">
                    @if (!string.IsNullOrEmpty(Model.ImageName))
                    {
                        <div class="text-center" style="width: 180px">
                            <button class="btn btn-primary custom-btn col-12 align-content-center my-1 shadow" type="button" id="viewImage"><i class="bi bi-eye"></i> View Image</button>
                        </div>
                        <div class="text-center" style="width: 180px">
                            <button class="btn btn-outline-danger col-12 align-content-center selected-options my-1 shadow" type="button" id="deleteImage" data-image-id="@Model.DispatchTicketId">
                                <i class="bi bi-trash-fill"></i> Delete Image
                            </button>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Model.VideoName))
                    {
                        <div class="text-center" style="width: 180px">
                            <button class="btn btn-primary custom-btn col-12 align-content-center my-1 view-video shadow" data-videolink="@Model.VideoSignedUrl" type="button"><i class="bi bi-play-circle"></i> Play Video</button>
                        </div>
                        <div class="text-center" style="width: 180px">
                            <button class="btn btn-outline-danger col-12 align-content-center selected-options my-1 shadow" type="button" id="deleteVideo" data-video-id="@Model.DispatchTicketId">
                                <i class="bi bi-trash-fill"></i> Delete Video
                            </button>
                        </div>
                    }
                    <div class="text-center" style="width: 150px">
                        <button class="btn btn-primary custom-btn col-12 align-content-center selected-options shadow" type="submit" id="submitButton"><i class="bi bi-check-circle"></i> Save</button>
                    </div>
                    <div class="text-center" style="width: 150px">
                        <a class="btn btn-outline-primary col-12 align-content-center selected-options shadow" asp-controller="ServiceRequest" asp-action="Index" asp-route-filterType="@filterType">
                            <i class="bi bi-arrow-90deg-left"></i> Go Back
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Image Preview
            document.getElementById('viewImage')?.addEventListener('click', function () {
                let maxHeight = window.innerHeight * 0.8;
                Swal.fire({
                    imageUrl: '@Html.Raw(Model.ImageSignedUrl)',
                    imageAlt: "Service Request Image",
                    showConfirmButton: false,
                    background: 'transparent',
                    padding: 0,
                    width: 'auto',
                    heightAuto: true,
                    didOpen: () => {
                        $('.swal2-image').css({'max-height': maxHeight + 'px', 'height': 'auto'});
                    }
                });
            });

            // Video Preview
            $(document).on("click", ".view-video", function () {
                const videoLink = this.getAttribute("data-videolink");
                if (!videoLink) return;
                Swal.fire({
                    html: `<video width="100%" height="auto" controls autofocus><source src="${videoLink}" type="video/mp4">Your browser does not support the video tag.</video>`,
                    showConfirmButton: false,
                    background: 'transparent',
                    width: '80%',
                });
            });

            // Port/Terminal Logic
            const port = $("#PortSelect");
            const terminalSelectVar = $("#TerminalSelect");
            const terminalLoading = $("#terminalLoading");
            
            function HandlePortChange() {
                let portId = port.val();
                if (!portId) return;
                terminalLoading.show();
                $.ajax({
                    url: '@Url.Action("ChangeTerminal", "DispatchTicket")',
                    type: "GET",
                    data: { portId: portId },
                    success: function (data) {
                        terminalSelectVar.empty();
                        terminalSelectVar.append('<option value="">Select Terminal</option>');
                        if (Array.isArray(data)) {
                            $.each(data, function (index, item) {
                                terminalSelectVar.append($('<option>', { value: item.value, text: item.text }));
                            });
                        }
                    },
                    complete: function() { terminalLoading.hide(); }
                });
            }
            port.change(HandlePortChange);

            // Duration Logic
            const dateLeft = $("#DateLeft");
            const timeLeft = $("#TimeLeft");
            const dateArrived = $("#DateArrived");
            const timeArrived = $("#TimeArrived");
            const durationDisplay = $("#durationDisplay");
            const totalHoursSpan = $("#totalHours");

            function calculateDuration() {
                if (dateLeft.val() && timeLeft.val() && dateArrived.val() && timeArrived.val()) {
                    const start = new Date(`${dateLeft.val()}T${timeLeft.val()}`);
                    const end = new Date(`${dateArrived.val()}T${timeArrived.val()}`);
                    if (!isNaN(start) && !isNaN(end)) {
                        const diffMs = end - start;
                        if (diffMs < 0) {
                            durationDisplay.removeClass("bg-secondary").addClass("bg-danger").show();
                            totalHoursSpan.text("Invalid (End before Start)");
                        } else {
                            durationDisplay.removeClass("bg-danger").addClass("bg-secondary").show();
                            totalHoursSpan.text((diffMs / 3600000).toFixed(2));
                        }
                    }
                } else {
                    durationDisplay.hide();
                }
            }
            $(".timeline-input").on("input change", calculateDuration);
            calculateDuration();

            // Deletion Logic
            $("#deleteImage").click(function () {
                Swal.fire({ title: "Delete image?", showCancelButton: true }).then((r) => {
                    if (r.isConfirmed) window.location.href = '@Url.Action("DeleteImage", "ServiceRequest", new { id = Model.DispatchTicketId })';
                });
            });
            $("#deleteVideo").click(function () {
                Swal.fire({ title: "Delete video?", showCancelButton: true }).then((r) => {
                    if (r.isConfirmed) window.location.href = '@Url.Action("DeleteVideo", "ServiceRequest", new { id = Model.DispatchTicketId })';
                });
            });

            // Submit Confirmation
            $("#submitButton").click(function (e) {
                const hasExisting = '@Model.ImageName' || '@Model.VideoName';
                const hasNew = $("#imageUpload")[0].files.length || $("#videoUpload")[0].files.length;
                const form = document.getElementById('myForm');

                if (hasExisting && hasNew) {
                    e.preventDefault();
                    Swal.fire({ title: "Replace files?", text: "Current file(s) will be replaced.", showCancelButton: true }).then((r) => {
                        if (r.isConfirmed) {
                            if (form.checkValidity()) form.submit();
                            else form.reportValidity();
                        }
                    });
                }
            });
        });
    </script>
}
