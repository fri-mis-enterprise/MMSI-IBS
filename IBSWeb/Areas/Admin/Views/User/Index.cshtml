@{
    ViewData["Title"] = "User Management";
}

<!-- Antiforgery Token -->
@Html.AntiForgeryToken()

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<style>
    .container {
        max-width: 100% !important;
        width: 100% !important;
    }

    /* Custom styles for professional look */
    .table th {
        font-weight: 600;
        color: #374151;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.025em;
    }

    .table tbody tr {
        transition: all 0.2s;
    }

    .table tbody tr:hover {
        background-color: rgba(59, 130, 246, 0.05);
    }

    .table-loading {
        position: relative;
        opacity: 0.6;
    }

    .badge {
        font-weight: 500;
        padding: 0.35em 0.8em;
        font-size: 0.75rem;
    }

    .actions-dropdown .dropdown-item {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
    }

    .actions-dropdown .dropdown-item:hover {
        background-color: #f3f4f6;
    }
</style>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center bg-secondary p-3 rounded shadow">
        <h2 class="text-white m-0">@ViewData["Title"]</h2>
        <button type="button" class="btn btn-light" onclick="openUpsertModal()">
            <i class="bi bi-plus-circle"></i> Create New User
        </button>
    </div>

    <div class="card shadow border-0 mt-3">
        <div class="card-body p-3">
            <div class="table-responsive" style="max-height: 70vh">
                <table id="userTable" class="table table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="text-start">Username</th>
                            <th class="text-start">Full Name</th>
                            <th class="text-start">Department</th>
                            <th class="text-start">Role</th>
                            <th class="text-start">Station</th>
                            <th class="text-start">Status</th>
                            <th class="text-start">Created</th>
                            <th class="text-start">Modified</th>
                            <th class="text-start">Actions</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ========== CREATE/EDIT USER MODAL ========== -->
<div class="modal fade" id="upsertModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">Create User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId" />

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="username" required />
                            <small class="text-muted">Cannot be changed after creation</small>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Full Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" oninput="this.value = this.value.toUpperCase()" required />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="department" class="form-label">Department <span class="text-danger">*</span></label>
                            <select class="form-select js-select2" id="department" required>
                                <option value="">Select department</option>
                                <option value="Accounting">Accounting</option>
                                <option value="Credit and Collection">Credit and Collection</option>
                                <option value="Engineering">Engineering</option>
                                <option value="Finance">Finance</option>
                                <option value="HR and Admin/Legal">HR and Admin/Legal</option>
                                <option value="Logistics">Logistics</option>
                                <option value="Management Accounting">Management Accounting</option>
                                <option value="Marketing">Marketing</option>
                                <option value="MIS">MIS</option>
                                <option value="Operation">Operation</option>
                                <option value="RCD">RCD</option>
                                <option value="Retail Admin">Retail Admin</option>
                                <option value="Retail Audit">Retail Audit</option>
                                <option value="Site Dev and Site Acquisition">Site Dev and Site Acquisition</option>
                                <option value="Station Cashier">Station Cashier</option>
                                <option value="Trade and Supply">Trade and Supply</option>
                                <option value="Training and Compliance">Training and Compliance</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="role" class="form-label">Role <span class="text-danger">*</span></label>
                            <select class="form-select js-select2" id="role" required>
                                <option value="">Select role</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3" id="stationDiv" style="display: none;">
                            <label for="stationAccess" class="form-label">Station <span class="text-danger">*</span></label>
                            <select class="form-select js-select2" id="stationAccess">
                                <option value="">Select station</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="isActive" class="form-label">Status</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isActive" checked />
                                <label class="form-check-label" for="isActive">
                                    <span id="statusLabel">Active</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div id="passwordSection">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="password" class="form-label">Password <span class="text-danger" id="passwordRequired">*</span></label>
                                <input type="password" class="form-control" id="password" />
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="confirmPassword" class="form-label">Confirm Password <span class="text-danger" id="confirmRequired">*</span></label>
                                <input type="password" class="form-control" id="confirmPassword" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveUserBtn" onclick="saveUser()">
                    <i class="bi bi-save"></i> Save User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ========== RESET PASSWORD MODAL ========== -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Reset Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="resetPasswordForm">
                    <input type="hidden" id="resetUserId" />
                    <p>Reset password for: <strong id="resetUsername"></strong></p>

                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="newPassword" required />
                    </div>

                    <div class="mb-3">
                        <label for="confirmNewPassword" class="form-label">Confirm New Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="confirmNewPassword" required />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="resetPasswordBtn" onclick="resetPassword()">
                    <i class="bi bi-key"></i> Reset Password
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        let userTable;
        let upsertModal;
        let resetPasswordModal;
        let shouldRefreshOnClose = false;

        function getAntiforgeryToken() {
            return $('input[name="__RequestVerificationToken"]').val();
        }

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (settings.type === 'POST' || settings.type === 'PUT' || settings.type === 'DELETE') {
                    xhr.setRequestHeader('RequestVerificationToken', getAntiforgeryToken());
                }
            }
        });

        $(document).ready(function () {
            upsertModal = new bootstrap.Modal(document.getElementById('upsertModal'));
            resetPasswordModal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));

            initializeSelect2();

            userTable = $('#userTable').DataTable({
                "order": [[6, 'desc']],
                "columnDefs": [
                    { "orderable": false, "targets": [8] }
                ],
                "processing": true,
                "stateDuration": 86400,
                "language": {
                    "processing": `<div class="d-flex justify-content-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                 </div>`,
                    "emptyTable": "No users found"
                },
                ajax: {
                    url: '/Admin/User/GetAll',
                    dataSrc: 'data',
                    error: function(xhr, error, code) {
                        console.error('DataTable error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to load users. Please refresh the page.'
                        });
                    }
                },
                "preDrawCallback": function (settings) {
                    $('#userTable').addClass('table-loading');
                },
                "drawCallback": function (settings) {
                    $('#userTable').removeClass('table-loading');
                    $('[data-bs-toggle="tooltip"]').tooltip();
                },
                columns: [
                    { data: 'username', render: data => escapeHtml(data) },
                    { data: 'name', render: data => escapeHtml(data) },
                    { data: 'department', render: data => escapeHtml(data) },
                    { data: 'role', render: data => escapeHtml(data) },
                    { data: 'stationAccess', render: data => escapeHtml(data) },
                    {
                        data: 'isActive',
                        render: function (data) {
                            return data
                                ? '<span class="badge bg-success">Active</span>'
                                : '<span class="badge bg-danger">Inactive</span>';
                        }
                    },
                    { data: 'createdDate' },
                    { 
                        data: null,
                        render: function(data) {
                            return data.modifiedDate !== 'N/A' 
                                ? `${escapeHtml(data.modifiedDate)}<br/><small class="text-muted">by ${escapeHtml(data.modifiedBy)}</small>`
                                : 'N/A';
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        render: function (data) {
                            return `
                                <button class="btn btn-sm btn-info btn-edit-user" data-user-id="${escapeHtml(data.id)}" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm ${data.isActive ? 'btn-warning' : 'btn-success'} btn-toggle-status" 
                                        data-user-id="${escapeHtml(data.id)}" 
                                        data-username="${escapeHtml(data.username)}"
                                        title="${data.isActive ? 'Deactivate' : 'Activate'}">
                                    <i class="bi bi-${data.isActive ? 'x-circle' : 'check-circle'}"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary btn-reset-password" 
                                        data-user-id="${escapeHtml(data.id)}" 
                                        data-username="${escapeHtml(data.username)}"
                                        title="Reset Password">
                                    <i class="bi bi-key"></i>
                                </button>
                            `;
                        }
                    }
                ],
                order: [[6, 'desc']],
                pageLength: 25,
                responsive: true,
                language: {
                    emptyTable: "No users found"
                }
            });

            $('#userTable').on('click', '.btn-edit-user', function() {
                openUpsertModal($(this).data('user-id'));
            });

            $('#userTable').on('click', '.btn-toggle-status', function() {
                toggleStatus($(this).data('user-id'), $(this).data('username'));
            });

            $('#userTable').on('click', '.btn-reset-password', function() {
                openResetPasswordModal($(this).data('user-id'), $(this).data('username'));
            });

            loadRoles();
            loadStations();

            $('#department, #role').on('change', toggleStationField);

            $('#isActive').on('change', function () {
                $('#statusLabel').text(this.checked ? 'Active' : 'Inactive');
            });

            $('#upsertModal').on('shown.bs.modal', function () {
                initializeSelect2();
            });

            $('#upsertModal').on('hidden.bs.modal', function () {
                $('.js-select2').select2('destroy');
                if (shouldRefreshOnClose) {
                    userTable.ajax.reload(null, false);
                    shouldRefreshOnClose = false;
                }
            });

            $('#resetPasswordModal').on('hidden.bs.modal', function () {
                if (shouldRefreshOnClose) {
                    userTable.ajax.reload(null, false);
                    shouldRefreshOnClose = false;
                }
            });
        });

        function escapeHtml(text) {
            if (text == null) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        function initializeSelect2() {
            $('.js-select2').each(function() {
                if ($(this).hasClass('select2-hidden-accessible')) {
                    $(this).select2('destroy');
                }
            });

            $('.js-select2').select2({
                theme: 'bootstrap-5',
                width: '100%',
                dropdownParent: $('#upsertModal'),
                placeholder: function() {
                    return $(this).find('option:first').text();
                },
                allowClear: false
            });
        }

        function loadRoles() {
            $.get('/Admin/User/GetRoles')
                .done(function (data) {
                    const roleSelect = $('#role');
                    roleSelect.empty().append('<option value="">Select role</option>');
                    data.forEach(role => {
                        roleSelect.append(`<option value="${escapeHtml(role.value)}">${escapeHtml(role.text)}</option>`);
                    });
                    if (roleSelect.hasClass('select2-hidden-accessible')) {
                        roleSelect.select2('destroy');
                        initializeSelect2();
                    }
                })
                .fail(function() {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to load roles'
                    });
                });
        }

        function loadStations() {
            $.get('/Admin/User/GetStations')
                .done(function (data) {
                    const stationSelect = $('#stationAccess');
                    stationSelect.empty().append('<option value="">Select station</option>');
                    data.forEach(station => {
                        stationSelect.append(`<option value="${escapeHtml(station.value)}">${escapeHtml(station.text)}</option>`);
                    });
                    if (stationSelect.hasClass('select2-hidden-accessible')) {
                        stationSelect.select2('destroy');
                        initializeSelect2();
                    }
                })
                .fail(function() {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to load stations'
                    });
                });
        }

        function toggleStationField() {
            const department = $('#department').val();
            const role = $('#role').val();
            const stationDiv = $('#stationDiv');

            if (department === 'Station Cashier' && role === 'Cashier') {
                stationDiv.show();
                $('#stationAccess').prop('required', true);
            } else {
                stationDiv.hide();
                $('#stationAccess').prop('required', false).val('').trigger('change');
            }
        }

        function openUpsertModal(userId = null) {
            $('#userForm')[0].reset();
            $('#userId').val('');
            $('#username').prop('readonly', false);
            $('#passwordSection').show();
            $('#password, #confirmPassword').val('').prop('required', true);
            $('#passwordRequired, #confirmRequired').show();
            $('#modalTitle').text('Create User');
            $('#isActive').prop('checked', true);
            $('#statusLabel').text('Active');
            $('#stationDiv').hide();
            $('#department, #role, #stationAccess').val('').trigger('change');

            if (userId) {
                $.get(`/Admin/User/GetUser?id=${encodeURIComponent(userId)}`)
                    .done(function (response) {
                        if (response.success) {
                            const user = response.data;
                            $('#userId').val(user.id);
                            $('#username').val(user.username).prop('readonly', true);
                            $('#name').val(user.name);
                            $('#department').val(user.department).trigger('change');
                            
                            setTimeout(() => {
                                $('#role').val(user.role).trigger('change');
                                setTimeout(() => {
                                    if (user.stationAccess) {
                                        $('#stationAccess').val(user.stationAccess).trigger('change');
                                    }
                                }, 100);
                            }, 100);
                            
                            $('#isActive').prop('checked', user.isActive);
                            $('#statusLabel').text(user.isActive ? 'Active' : 'Inactive');
                            $('#modalTitle').text('Edit User');
                            $('#passwordSection').hide();
                            $('#password, #confirmPassword').val('').prop('required', false);
                            toggleStationField();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: response.message
                            });
                        }
                    })
                    .fail(function() {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to load user details'
                        });
                    });
            }

            upsertModal.show();
        }

        function saveUser() {
            const userId = $('#userId').val();
            const username = $('#username').val().trim();
            const name = $('#name').val().trim();
            const department = $('#department').val();
            const role = $('#role').val();
            const stationAccess = $('#stationAccess').val();
            const password = $('#password').val();
            const confirmPassword = $('#confirmPassword').val();
            const isActive = $('#isActive').is(':checked');

            if (!username || !name || !department || !role) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Validation Error',
                    text: 'Please fill in all required fields'
                });
                return;
            }

            if (department === 'Station Cashier' && role === 'Cashier' && !stationAccess) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Validation Error',
                    text: 'Please select a station for cashier role'
                });
                return;
            }

            if (!userId) {
                if (!password || password.length < 6) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Validation Error',
                        text: 'Password must be at least 6 characters'
                    });
                    return;
                }
                if (password !== confirmPassword) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Validation Error',
                        text: 'Passwords do not match'
                    });
                    return;
                }
            }

            const saveBtn = $('#saveUserBtn');
            saveBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Saving...');

            const userData = {
                Id: userId || null,
                Username: username,
                Name: name,
                Department: department,
                Role: role,
                StationAccess: stationAccess || null,
                Password: userId ? null : password,
                IsActive: isActive
            };

            $.ajax({
                url: '/Admin/User/Upsert',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(userData),
                success: function (response) {
                    saveBtn.prop('disabled', false).html('<i class="bi bi-save"></i> Save User');
                    
                    if (response.success) {
                        shouldRefreshOnClose = true;
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: response.message,
                            timer: 2000,
                            showConfirmButton: false
                        }).then(() => {
                            upsertModal.hide();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.message
                        });
                    }
                },
                error: function (xhr) {
                    saveBtn.prop('disabled', false).html('<i class="bi bi-save"></i> Save User');
                    
                    const message = xhr.responseJSON?.message || 'An error occurred while saving the user';
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: message
                    });
                }
            });
        }

        function toggleStatus(userId, username) {
            Swal.fire({
                title: 'Confirm Action',
                text: `Are you sure you want to toggle the status of ${username}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, proceed',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Processing...',
                        text: 'Please wait',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    $.post(`/Admin/User/ToggleStatus?id=${encodeURIComponent(userId)}`)
                        .done(function (response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: response.message,
                                    timer: 2000,
                                    showConfirmButton: false
                                }).then(() => {
                                    userTable.ajax.reload(null, false);
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: response.message
                                });
                            }
                        })
                        .fail(function(xhr) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Failed to toggle user status. Please try again.'
                            });
                        });
                }
            });
        }

        function openResetPasswordModal(userId, username) {
            $('#resetPasswordForm')[0].reset();
            $('#resetUserId').val(userId);
            $('#resetUsername').text(username);
            resetPasswordModal.show();
        }

        function resetPassword() {
            const userId = $('#resetUserId').val();
            const newPassword = $('#newPassword').val();
            const confirmNewPassword = $('#confirmNewPassword').val();

            if (!newPassword || newPassword.length < 6) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Validation Error',
                    text: 'Password must be at least 6 characters'
                });
                return;
            }

            if (newPassword !== confirmNewPassword) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Validation Error',
                    text: 'Passwords do not match'
                });
                return;
            }

            const resetBtn = $('#resetPasswordBtn');
            resetBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Resetting...');

            $.ajax({
                url: '/Admin/User/ResetPassword',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    UserId: userId,
                    NewPassword: newPassword
                }),
                success: function (response) {
                    resetBtn.prop('disabled', false).html('<i class="bi bi-key"></i> Reset Password');
                    
                    if (response.success) {
                        shouldRefreshOnClose = true;
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: response.message,
                            timer: 2000,
                            showConfirmButton: false
                        }).then(() => {
                            resetPasswordModal.hide();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.message
                        });
                    }
                },
                error: function (xhr) {
                    resetBtn.prop('disabled', false).html('<i class="bi bi-key"></i> Reset Password');
                    
                    const message = xhr.responseJSON?.message || 'An error occurred while resetting password';
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: message
                    });
                }
            });
        }
    </script>
}
